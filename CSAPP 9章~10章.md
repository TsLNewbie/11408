---
title: CSAPP 9章~10章
category: /小书匠/日记/2024-06
grammar_cjkRuby: true
---

# 第 九 章 虚拟内存

在计算机系统中，多个进程之间共享CPU和内存
如果太多的进程需要过多的内存空间
那么其中一部分进程就会因为无法获得足够的内存空间而无法运行

除此之外，如果某个进程不小心把数据写入到 另外一个进程的内存空间中 
那么接下来就会发生一些令人困感的错误

>为了有效管理内存
现代计算机系统提供了一种对内存的抽象概念，叫做**虚拟内存**
它可以自动的完成内存管理的相关工作，并不需要应用程序员来干预

学习原因：

- 虚拟内存是核心
- 虚拟内存是强大的
	- 创建和释放内存空间，将内存空间映射到磁盘的某个部分。
- 虚拟内存是危险的
	- 虚拟内存使用不当，会产生很严重的错误。


## 9.1 虚拟内存 Virtual Memory

### 物理地址

![](./images/1717753334180.png)
>CPU访问内存最直接的方式就是使用物理地址 —— **物理寻址**（名词）

图中例子：
该指令的起始地址 = 2 ，长度 = 4 byte

此时CPU在读取这条指令时，就会生成一个有效的物理地址。
这个物理地址通过内存总线传递给内存控制器

内存响应：
从物理地址2开始的地方取出4个字节的内容返回给CPU


### 虚拟寻址 Virtual Addressing

>不过现在CPU用的是**虚拟寻址**。

![](./images/1717753446819.png)

在这种寻址模式下，CPU是通过一个虚拟地址来访问内存的。
这个虚以地址在被送到内存之前，需要先转换成相应的物理地址


将一个虚以地址转换成物理地址的任务叫做**地址翻译**（名词）。
在CPU芯片内部有一个专门的功能部件来做地址转换 —— **内存管理单元(MMU)** (名词)

>MMU 是位于 CPU 内的寄存器


### 地址空间（重要概念）

>地址空间是一个非负整数的有序集合。
>如果地址空间中的整数是连续的，那么我们说它是一个线性地址空间。(假设都是线性地址空间)

一个地址空间的大小是由表示最大地址所需要的位数来描述的。

![](./images/1717753613177.png)


例如：
一个8位的虚拟地址空间，一共包含2的8次方个虚拟地址数
一个32位的虚拟地址空间，一共包含2的32次方个虚拟地址数

除此之外，系统中还有一个物理地址空间概念
它对应于系统中的物理内存。

例如物理内存有M个字节，那么物理地址空间就是0~M-1。

>特别注意：：是虚拟内存地址与物理地址的差别


虚拟内存是如何用作缓存：

从概念上讲，虚拟内存可以看成一个由磁盘上N个连续的字节所组成的数组
其中每一个字节都有一个唯一的虚拟地址，这个虚拟地址就是数组的**索引值**。


![](./images/1717753931751.png)
其中虚拟地址的范围是0~N-1
对于磁盘上数组的内容被缓存到内存里

与存储器层次架构中其他缓存一样
磁盘上的数据被分割成块，这些块作为磁盘和内存之间的传输单元。


我们把这些数据块称为虚拟页，简称**VP**（名词）
每个虚拟页的大小为P个字节，通常P的值在4KB~2MB之间


类以的，物理内存也被分割为物理页 **(PP)** = 页帧(Page frame)
物理页与虚拟页的**大小是一样**的，也是P个字节.

关于虚拟页面可以分为三类：

- 未分配 Unallocated
	- 虚拟内存系统还没有创建的页
	- 没有任何数据和它们相关联
	- 不占用任何磁盘空间
-  已缓存的 Cached
	-  已经缓存在物理内存页中
	-  例如：VP1，4，6
- 未缓存  Uncached
	- 已经被分配，但并未缓存在内存中
	-	例如：VP2, 5, 7



为了方便理解存储层次结构中不同的缓存概念


![](./images/1717754107878.png)
>DRAM 比 SRAM 慢十倍， 磁盘 比 DRAM 慢 10万倍。
>因此，DRAM缓存不命中比SRAM缓存不命中对程序执行的影响更大


>所以DRAM缓存采用**全相联**的联结方式
也就是说任何的虚拟页可以放在任意一个内存页中。

除此之外，不命中时的替换策略也非常重要
如果替换错了，那么也会耽误很长的时间。

>与cache的替换算法相l比，DRAM缓存的替换算法更加复杂
不过这个替换算法不在本书的讲述范围之内(())

>磁盘访问的时间很长
所以DRAM缓存总是采用**写回**的策略，而不是**写穿透**


引入虚拟内存（VM）

- 有效使用主存
	- 使用DRAM作为部分虚拟地址空间的缓存
- 简化内存管理
	-	每个进程都使用统一的线性地址空间
- 独立地址空间
	-	一个进程不能影响其他进程的内存
	- 用户程序无法获取特权内核信息和代码


![](./images/1717771670150.png)
>玩游戏的过程，每走到一个地方，就会加载地图，这段过程就是虚拟内存执行。


> **页表** 一页表条目的数值，将虚拟页地址映射到物理页地址。
> DRAM中的每个进程都使用的核心数据结构。

![](./images/1717772009603.png)

PTE 1 = VP1 = 物理内存 VP1 PP0 
PTE3 灰色： 未缓存状态。

### Page Hit 页命中

>虚拟内存中 一个字存在于物理内存中。

![](./images/1717772270025.png)
### Page Fault 缺页

>虚拟内存中的字不在物理内存中（DRAM缓存不命中）
>地址翻译硬件 从内存中读取PTE3, 从有效位推断出VP3未被缓存。

![](./images/1717772301149.png)
#### Handling Page Fault 缺页的处理

>缺页导致页面出错（缺页异常）
>VM缺页（之前）对VP3中的字的引用不命中。
>选择一个**牺牲页**（此例子是VP4)
>VP3

![](./images/1717772468239.png)

>缺页异常调用内核中的 缺页异常处理程序，该程序选择一个牺牲页，（本次就是VP4),如果VP4已经被修改了，那么内核就会将它复制会磁盘。
>无论什么情况，内核都会修改VP4的页表条目，反映出VP4不再缓存在主存中。
>内核从硬盘复制VP3到内存PP3，更新PTE3，随后返回，这样就有东西了。

VP4的位置被牺牲。

![](./images/1717773153357.png)
VP3 代替了他，此时VP3就有物理内存地址了。

![](./images/1717773160831.png)
分配页面。

![](./images/1717773254701.png)

又是局部性救了我们！

- 虚拟内存看上去效率非常低，但它工作得相当好，这都要归功于“局部性”.
- 在任意时间，程序将趋于在一个较小的活动页面集合上工作，这个集合叫做工作集Working set
	- 程序的时间局部性越好，工作集就会越小
- 如果（工作集的大小<物理内存的大小)
	- 在初始开销后，对工作集的引用将导致命中。
- 如果（工作集的大小>物理内存的大小）
	 - Thrashing.抖动：页面不断地换进换出，导致系统性能崩溃。




### 虚拟内存作为内存管理的工具

>Key idea ： 每个进程都拥有一个独立的虚拟地址空间


![](./images/1717773381589.png)

VM简化了很多个方面：
- 简化内存分配
	- 每个VM都可以映射到一个物理页面
	- 一个VM可以分配到不同的物理页面（可不连续）
- 简化代码和数据共享
	- 不同的VM映射到相同的物理页面。
- 简化链接
	- 独立的地址空间允许每个程序使用相似的VM
	- 代码，数据和堆都使用相同的起始地址。
- 简化加载
	- execve 为代码段和数据段分配虚拟页，并标记为无效。
	- 每个页面被初始引用时，虚拟内存系统会按照需要自动地跳入数据页。
- 简化共享


![代码和数据共享](./images/1717773594077.png)

![链接和加载](./images/1717773688776.png)


![](./images/1717773713648.png)


### 虚拟内存作为内存保护的工具

>在PTE上拓展许可位以提供更好的访问控制。
>内存管理单元（MMU）每次访问数据都需要检查 **许可位**。

![](./images/1717773780994.png)
>可能会发生的异常情况（重点）

![](./images/1717773795201.png)


#### 地址翻译 VM address Translation

![](./images/1717773829211.png)
地址翻译使用到的所有符号：

- Basic Parameters基本参数
	-	N=2^n:虚拟地址空间中的地址数量
	-	M=2^m:物理地址空间中的地址数量
	-	P=2^p:页的大小(bytes)
-	Components of the virtual address(VA)虚拟地址组成部分
	-	TLB:TLB index--TLB索引
	-	TLBT:TLB tag---TLB标记
	-	VPO:Virtual page offset--虚拟页面偏移量（字节）
	-	1VPN:Virtual page number---虚拟页号
-	Components of the physical address(PA)物理地址组成部分
	-	PPO:Physical page offset(same as VPO)--物理页面偏移量
	-	PPN:Physical page number--物理页号


![](./images/1717774247585.png)


# 第 十 章 系统级 I/O